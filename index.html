<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GreenTrack Prototipo Unificato</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f7faf7; margin: 0; padding: 0; }
    header { background: #4caf50; color: #fff; padding: 1.2rem 0; text-align: center; letter-spacing: 2px; position: relative;}
    nav.topnav { position: absolute; top: 0; right: 0; margin: 0.8rem 2rem 0 0; }
    nav.topnav a {
      color: #fff;
      background: #388e3c;
      text-decoration: none;
      padding: 0.5rem 1.2rem;
      border-radius: 5px;
      font-size: 1rem;
      margin-left: 1rem;
      transition: background 0.2s;
    }
    nav.topnav a:hover { background: #256029; }
    .container { max-width: 700px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 0 16px rgba(0,0,0,0.06); padding: 2rem; text-align: center; }
    h2 { color: #388e3c; margin-bottom: 1.5rem; }
    .project-card { background: #e8f5e9; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 0 8px rgba(0,0,0,0.05); text-align: left; }
    .btn-primary { background: #4caf50; color: white; border: none; padding: 1rem 2rem; font-size: 1.2rem; border-radius: 6px; cursor: pointer; }
    .btn-primary:hover { background: #388e3c; }
    .btn-small { font-size: 0.95em; padding: 0.3em 1em; margin: 0.2em 0; }
    .project-info { margin-bottom: 0.5rem; }
    label { display: block; margin-top: 1rem; font-weight: bold; text-align: left;}
    select, input[type=number], input[type=text], input[type=date], textarea { width: 100%; padding: 0.5rem; margin-top: 0.3rem; border: 1px solid #ccc; border-radius: 4px; }
    .step { margin-bottom: 2rem; }
    .hidden { display: none; }
    .checkbox-group { margin-top: 0.5rem; margin-bottom: 1rem; }
    .checkbox-group label { font-weight: normal; display: block; margin-left: 1rem; }
    .nav { margin-bottom: 2rem; }
    .nav button { background: none; border: none; color: #333; font-size: 1.1rem; padding: 0.5rem 1rem; cursor: pointer; border-radius: 5px; }
    .nav button.active, .nav button:hover { background: #4caf50; color: #fff; }
    .dashboard-summary { display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.5rem; }
    .dashboard-summary .card { flex: 1 1 250px; background: #f4f9f4; border-radius: 8px; padding: 1rem 1.5rem; margin-bottom: 0; box-shadow: 0 0 6px rgba(0,0,0,0.04); position: relative;}
    .edit-icon {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.2em;
      color: #388e3c;
      background: #e8f5e9;
      border: none;
      cursor: pointer;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }
    .edit-icon:hover {
      background: #c8e6c9;
    }
    .plant-list { margin: 0; padding: 0; list-style: none; }
    .plant-list li { padding: 0.6rem 0; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
    .plant-list li:last-child { border-bottom: none; }
    .dashboard-nav {
      margin: 1.5rem 0 1rem 0;
      display: flex;
      width: 100%;
      justify-content: stretch;
      align-items: stretch;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 3px rgba(0,0,0,0.04);
      background: #f8f8f8;
    }
    .dashboard-nav button {
      flex: 1 1 0;
      min-width: 0;
      margin: 0;
      padding: 0.6rem 0.2rem;
      font-size: 1.1rem;
      border: none;
      border-right: 1px solid #e0e0e0;
      border-radius: 0;
      background: #f8f8f8;
      transition: background 0.2s;
      outline: none;
    }
    .dashboard-nav button:last-child {
      border-right: none;
    }
    .dashboard-nav button.active,
    .dashboard-nav button:hover {
      background: #4caf50;
      color: #fff;
    }
    @media (max-width: 700px) {
      .dashboard-nav button {
        font-size: 1rem;
        padding: 0.6rem 0.1rem;
      }
    }
    .suggested-plants-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 2rem;
    }
    @media (max-width: 700px) {
      .suggested-plants-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .container {
        padding: 1rem;
      }
    }
    .plant-card {
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      background: #fff;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      cursor: pointer;
      transition: border 0.2s;
      position: relative;
    }
    .plant-card:hover {
      border: 2px solid #4caf50;
    }
    .plant-card img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      display: block;
      margin-left: auto;
      margin-right: auto;
      border-radius: 6px;
    }
    .plant-card-name {
      margin-top: 8px;
      font-weight: bold;
    }
    
    /* Smart Suggestions Styling */
    .confidence-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 0.7em;
      font-weight: bold;
      color: white;
    }
    .confidence-very-high { background: #4caf50; }
    .confidence-high { background: #8bc34a; }
    .confidence-medium { background: #ff9800; }
    .confidence-low { background: #f44336; }
    
    .score-display {
      font-size: 0.8em;
      color: #388e3c;
      font-weight: bold;
      margin-top: 3px;
    }
    
    /* Task Category Styles */
    .task-category {
      margin-bottom: 2.5rem;
      text-align: left;
    }
    .task-category-header {
      font-size: 1.15rem;
      font-weight: bold;
      color: #388e3c;
      margin-bottom: 0.8rem;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 0.4rem;
      display: flex;
      align-items: center;
      gap: 0.5em;
    }
    .task-category-header .icon {
      font-size: 1.3em;
      margin-right: 0.3em;
    }
    .task-item {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.8rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      position: relative;
      transition: box-shadow 0.2s;
    }
    .task-item:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .task-item.overdue {
      border-left: 4px solid #f44336;
      background: #ffebee;
    }
    .task-item.due-today {
      border-left: 4px solid #ff9800;
      background: #fff3e0;
    }
    .task-item.upcoming {
      border-left: 4px solid #4caf50;
      background: #f1f8e9;
    }
    .task-item.completed {
      border-left: 4px solid #9e9e9e;
      background: #f5f5f5;
      opacity: 0.7;
    }
    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.4rem;
    }
    .task-title {
      font-weight: bold;
      color: #333;
      font-size: 1.08rem;
      margin-bottom: 0.2rem;
    }
    .task-priority {
      font-size: 0.8rem;
      padding: 0.2rem 0.5rem;
      border-radius: 12px;
      color: white;
      font-weight: bold;
      text-transform: uppercase;
    }
    .task-priority.high { background: #f44336; }
    .task-priority.medium { background: #ff9800; }
    .task-priority.low { background: #4caf50; }
    .task-plant {
      color: #388e3c;
      font-weight: bold;
      font-size: 0.9rem;
      margin-bottom: 0.3rem;
    }
    .task-description {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      line-height: 1.4;
    }
    .task-due-date {
      color: #888;
      font-size: 0.85rem;
      margin-bottom: 0.6rem;
    }
    .task-due-date.overdue { color: #f44336; font-weight: bold; }
    .task-due-date.due-today { color: #ff9800; font-weight: bold; }
    .task-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.6rem;
    }
    .task-btn {
      padding: 0.3rem 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 500;
      transition: background 0.2s;
    }
    .task-btn.complete {
      background: #4caf50;
      color: white;
    }
    .task-btn.complete:hover {
      background: #388e3c;
    }
    .task-btn.postpone {
      background: #ff9800;
      color: white;
    }
    .task-btn.postpone:hover {
      background: #f57c00;
    }
    .task-btn.skip {
      background: #9e9e9e;
      color: white;
    }
    .task-btn.skip:hover {
      background: #757575;
    }
    .no-tasks {
      text-align: center;
      color: #888;
      font-style: italic;
      padding: 2rem;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    @media (max-width: 700px) {
      .task-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .task-priority {
        margin-top: 0.3rem;
      }
      .task-actions {
        flex-wrap: wrap;
      }
    }
    
    #addPlantWireframe { max-width: 500px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 0 16px rgba(0,0,0,0.07); padding: 2rem; display: none;}
    #addPlantWireframe label {margin-top: 1rem;}
    #addPlantWireframe input, #addPlantWireframe textarea {margin-bottom: 1rem;}
    .responsive-table-container {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1.5rem;
    }
    .plant-table {
      width: 100%;
      min-width: 600px;
      font-size: 0.97em;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    .plant-table th, .plant-table td { border: 1px solid #e0e0e0; padding: 8px 4px; text-align: left; }
    .plant-table th { background: #e8f5e9; color: #388e3c; }
    .plant-table tr:nth-child(even) { background: #f9f9f9; }
    /* CARD STYLE FOR PLANTS ON MOBILE */
    .plant-cards-mobile { display: none; }
    @media (max-width: 700px) {
      .responsive-table-container { display: none !important; }
      .plant-cards-mobile {
        display: flex !important;
        flex-direction: column;
        gap: 1.2rem;
        margin-bottom: 1.2rem;
      }
      .plant-card-mobile {
        background: #f4f9f4;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        box-shadow: 0 0 8px rgba(0,0,0,0.04);
        padding: 1.1rem 1rem 0.7rem 1rem;
        text-align: left;
        position: relative;
      }
      .plant-card-mobile-row {
        display: flex;
        margin-bottom: 0.4em;
      }
      .plant-card-mobile-label {
        min-width: 95px;
        color: #388e3c;
        font-weight: bold;
        margin-right: 0.6em;
        flex-shrink: 0;
      }
      .plant-card-mobile-value {
        flex: 1;
      }
      .plant-card-mobile-trattamenti {
        margin: 0.6em 0 0.4em 0;
        padding: 0.7em 0.8em;
        background: #fff;
        border-radius: 7px;
        border: 1px solid #e0e0e0;
      }
      .plant-card-mobile-trattamenti-title {
        font-weight: bold;
        color: #388e3c;
        margin-bottom: 0.2em;
        font-size: 1.02em;
      }
      .plant-card-mobile-trattamenti-list {
        margin: 0;
        padding-left: 1.3em;
        font-size: 0.97em;
      }
      .plant-card-mobile-trattamenti-list li {
        margin-bottom: 0.2em;
      }
      .plant-card-mobile-cta {
        text-align: right;
        margin-top: 0.6em;
      }
    }
    @media (max-width: 700px) {
      .plant-table th, .plant-table td {
        padding: 0.4em 0.3em;
        font-size: 0.92em;
      }
      .plant-table {
        min-width: 520px;
        font-size: 0.92em;
      }
    }
    #editSpecsForm { max-width: 500px; margin: 2rem auto; background: #fff; border-radius: 12px; box-shadow: 0 0 16px rgba(0,0,0,0.07); padding: 2rem; display: none;}
    #editSpecsForm label {margin-top: 1rem;}
    #editSpecsForm input, #editSpecsForm select {margin-bottom: 1rem;}
    .checkbox-group-edit { margin-top: 0.5rem; margin-bottom: 1rem; display: flex; flex-wrap: wrap;}
    .checkbox-group-edit label { font-weight: normal; margin-right: 1.5rem; }
    #trattamentoPopup {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.25);
      z-index:1000;
      align-items: center;
      justify-content: center;
    }
    #trattamentoPopup .popup-content {
      background:#fff;
      border-radius:12px;
      max-width:350px;
      margin: 5% auto;
      padding:2rem 1.5rem 1rem 1.5rem;
      box-shadow:0 0 20px rgba(0,0,0,0.12);
      text-align:left;
      position:relative;
    }
    #trattamentoPopup label {margin-top:1rem;}
    #trattamentoPopup input, #trattamentoPopup textarea {margin-bottom:1rem;}
    #trattamentoPopup .popup-actions {text-align:center; margin-top:1.2rem;}
  </style>
</head>
<body>
  <header>
    <span>GreenTrack Prototipo Unificato</span>
    <nav class="topnav">
      <a href="#" onclick="goHome(event)">Home</a>
    </nav>
  </header>
  <div class="container">

    <!-- Onboarding Screen -->
    <form id="onboardingForm" autocomplete="off">
      <div class="step" id="step1">
        <h2>1. Qual è il tuo livello di esperienza nel giardinaggio?</h2>
        <select id="experience" required>
          <option value="" disabled selected>Seleziona il tuo livello</option>
          <option value="Principiante">Principiante</option>
          <option value="Intermedio">Intermedio</option>
          <option value="Esperto">Esperto</option>
        </select>
      </div>
      <div class="step" id="step2">
        <h2>2. Quanto tempo puoi dedicare al giardinaggio ogni giorno o settimana?</h2>
        <input type="number" id="timeAmount" min="0" placeholder="Inserisci il tempo" required />
        <select id="timeUnit" required>
          <option value="" disabled selected>Seleziona unità</option>
          <option value="minuti al giorno">Minuti al giorno</option>
          <option value="ore al giorno">Ore al giorno</option>
          <option value="minuti a settimana">Minuti a settimana</option>
          <option value="ore a settimana">Ore a settimana</option>
        </select>
      </div>
      <div class="step" id="step3">
        <h2>3. Qual è il tuo obiettivo principale per il giardinaggio?</h2>
        <select id="goal" required>
          <option value="" disabled selected>Seleziona il tuo obiettivo</option>
          <option value="Coltivare il mio cibo">Coltivare il mio cibo</option>
          <option value="Abbellire lo spazio">Abbellire lo spazio</option>
          <option value="Imparare una nuova abilità">Imparare una nuova abilità</option>
          <option value="Relax/terapia">Relax/terapia</option>
          <option value="Altro">Altro</option>
        </select>
      </div>
      <div class="step" id="step4">
        <h2>4. Vuoi ricevere consigli stagionali e migliori pratiche?</h2>
        <select id="tips" required>
          <option value="" disabled selected>Seleziona un'opzione</option>
          <option value="Sì">Sì, inviami consigli</option>
          <option value="No">No, solo le basi</option>
        </select>
      </div>
      <button type="submit" class="btn-primary">Completa Onboarding</button>
    </form>

    <!-- Homepage Screen -->
    <div id="homepage" class="hidden">
      <div class="nav">
        <button id="nav-home" class="active" onclick="showHomepage()">Home</button>
        <button id="nav-create" onclick="showProjectForm()">Crea Progetto</button>
      </div>
      <h2>Benvenuto su GreenTrack!</h2>
      <div id="projectArea"></div>
    </div>

    <!-- Project Creation Step 1: Address and Land Type -->
    <form id="projectForm1" class="hidden" autocomplete="off">
      <h2>Passo 1: Indirizzo e Tipo di Terreno</h2>
      <label for="projLocation">Indirizzo o posizione GPS</label>
      <input type="text" id="projLocation" placeholder="es. Calabria, Italia" required />

      <label for="projType">Tipo di terreno</label>
      <select id="projType" required>
        <option value="" disabled selected>Seleziona tipo</option>
        <option value="Esterno">Esterno</option>
        <option value="Interno">Interno</option>
        <option value="Balcone">Balcone</option>
        <option value="Giardino">Giardino</option>
      </select>

      <label for="projSize">Dimensione terreno (es. 20 m²)</label>
      <input type="text" id="projSize" placeholder="es. 20" required />

      <button type="button" class="btn-primary" id="nextToSoil">Avanti</button>
    </form>

    <!-- Project Creation Step 2: Soil/Environmental Conditions -->
    <form id="projectForm2" class="hidden" autocomplete="off">
      <h2>Passo 2: Suolo e Condizioni Ambientali</h2>

      <div class="checkbox-category">
        <label><strong>Suolo</strong></label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="soil" value="Argilloso" /> Argilloso</label>
          <label><input type="checkbox" name="soil" value="Sabbioso" /> Sabbioso</label>
          <label><input type="checkbox" name="soil" value="Limoso" /> Limoso</label>
          <label><input type="checkbox" name="soil" value="Roccioso" /> Roccioso</label>
        </div>
      </div>

      <div class="checkbox-category">
        <label><strong>Esposizione al Sole</strong></label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="sun" value="Pieno Sole" /> Pieno Sole</label>
          <label><input type="checkbox" name="sun" value="Mezzo Sole" /> Mezzo Sole</label>
          <label><input type="checkbox" name="sun" value="Ombra" /> Ombra</label>
        </div>
      </div>

      <div class="checkbox-category">
        <label><strong>Ambiente</strong></label>
        <div class="checkbox-group">
          <label><input type="checkbox" name="environment" value="Buon Drenaggio" /> Buon Drenaggio</label>
          <label><input type="checkbox" name="environment" value="Scarso Drenaggio" /> Scarso Drenaggio</label>
          <label><input type="checkbox" name="environment" value="Pianeggiante" /> Pianeggiante</label>
          <label><input type="checkbox" name="environment" value="In pendenza" /> In pendenza</label>
          <label><input type="checkbox" name="environment" value="Esposizione al vento" /> Esposizione al vento</label>
          <label><input type="checkbox" name="environment" value="Rischio gelo" /> Rischio gelo</label>
          <label><input type="checkbox" name="environment" value="Irrigazione disponibile" /> Irrigazione disponibile</label>
        </div>
      </div>

      <button type="button" class="btn-primary" id="backToDetails">Indietro</button>
      <button type="submit" class="btn-primary">Crea Progetto</button>
    </form>

    <!-- Project Dashboard Screen -->
    <div id="projectDashboard" class="hidden">
      <div class="dashboard-nav">
        <button onclick="showDashboardTab('overview')">Panoramica</button>
        <button onclick="showDashboardTab('plants')">Piante</button>
        <button onclick="showDashboardTab('tasks')">Attività</button>
        <button onclick="showDashboardTab('journal')">Diario</button>
      </div>
      <div id="dashboardContent"></div>
    </div>

    <!-- Edit Project Specs Screen -->
    <form id="editSpecsForm" class="hidden" autocomplete="off" onsubmit="event.preventDefault(); saveSpecsEdit();">
      <h2>Modifica specifiche progetto</h2>
      <label for="editProjType">Tipo di terreno</label>
      <select id="editProjType" required>
        <option value="Esterno">Esterno</option>
        <option value="Interno">Interno</option>
        <option value="Balcone">Balcone</option>
        <option value="Giardino">Giardino</option>
      </select>
      <label for="editProjSize">Dimensione terreno (es. 20 m²)</label>
      <input type="text" id="editProjSize" required />

      <label>Suolo</label>
      <div class="checkbox-group-edit" id="editSoilGroup">
        <label><input type="checkbox" name="editSoil" value="Argilloso" /> Argilloso</label>
        <label><input type="checkbox" name="editSoil" value="Sabbioso" /> Sabbioso</label>
        <label><input type="checkbox" name="editSoil" value="Limoso" /> Limoso</label>
        <label><input type="checkbox" name="editSoil" value="Roccioso" /> Roccioso</label>
      </div>

      <label>Esposizione al Sole</label>
      <div class="checkbox-group-edit" id="editSunGroup">
        <label><input type="checkbox" name="editSun" value="Pieno Sole" /> Pieno Sole</label>
        <label><input type="checkbox" name="editSun" value="Mezzo Sole" /> Mezzo Sole</label>
        <label><input type="checkbox" name="editSun" value="Ombra" /> Ombra</label>
      </div>

      <label>Ambiente</label>
      <div class="checkbox-group-edit" id="editEnvGroup">
        <label><input type="checkbox" name="editEnv" value="Buon Drenaggio" /> Buon Drenaggio</label>
        <label><input type="checkbox" name="editEnv" value="Scarso Drenaggio" /> Scarso Drenaggio</label>
        <label><input type="checkbox" name="editEnv" value="Pianeggiante" /> Pianeggiante</label>
        <label><input type="checkbox" name="editEnv" value="In pendenza" /> In pendenza</label>
        <label><input type="checkbox" name="editEnv" value="Esposizione al vento" /> Esposizione al vento</label>
        <label><input type="checkbox" name="editEnv" value="Rischio gelo" /> Rischio gelo</label>
        <label><input type="checkbox" name="editEnv" value="Irrigazione disponibile" /> Irrigazione disponibile</label>
      </div>
      <div style="text-align:center; margin-top:1.5rem;">
        <button class="btn-primary" type="submit" style="min-width:120px;">Salva</button>
        <button class="btn-primary" type="button" style="min-width:120px; background: #ccc; color: #222; margin-left:1rem;" onclick="cancelSpecsEdit()">Annulla</button>
      </div>
    </form>

    <!-- CREA LA TUA PIANTA - Wireframe con suggerimenti SMART -->
    <div id="addPlantWireframe" style="display:none;">
      <h2 style="color: #388e3c; text-align: center; margin-bottom: 1.5rem;">Crea la tua pianta</h2>
      <div>
        <h3 style="text-align:left;">🎯 Suggerimenti personalizzati per le tue condizioni</h3>
        <div class="suggested-plants-grid" id="smartSuggestionsGrid">
          <!-- Smart suggestions will be populated here -->
        </div>
      </div>
      <form id="addPlantForm" style="margin-top:2rem;" onsubmit="event.preventDefault(); saveWirePlant();">
        <label for="plantTypeWire">Nome pianta</label>
        <input type="text" id="plantTypeWire" placeholder="es. Pomodoro"/>
        <label for="plantVarietyWire">Varietà</label>
        <input type="text" id="plantVarietyWire" placeholder="es. San Marzano"/>
        <label for="plantQuantityWire">Quantità</label>
        <input type="number" id="plantQuantityWire" min="1"/>
        <label for="plantDateWire">Data di semina</label>
        <input type="date" id="plantDateWire"/>
        <label for="plantNotesWire">Note (opzionale)</label>
        <textarea id="plantNotesWire" placeholder="Note aggiuntive"></textarea>
        <div style="text-align:center; margin-top:1.5rem;">
          <button class="btn-primary" type="submit" style="min-width:120px;">Salva</button>
          <button class="btn-primary" type="button" style="min-width:120px; background: #ccc; color: #222; margin-left:1rem;" onclick="cancelAddPlantWire()">Annulla</button>
        </div>
      </form>
    </div>

    <!-- Popup for Trattamenti Speciali per pianta -->
    <div id="trattamentoPopup">
      <div class="popup-content">
        <h3>Aggiungi trattamento speciale</h3>
        <form id="trattamentoForm" onsubmit="event.preventDefault(); saveTrattamento();">
          <label for="trattamentoNome">Nome trattamento</label>
          <input type="text" id="trattamentoNome" required>
          <label for="trattamentoCadence">Cadenza</label>
          <input type="text" id="trattamentoCadence" placeholder="es. ogni 2 settimane" required>
          <label for="trattamentoData">Data</label>
          <input type="date" id="trattamentoData" required>
          <label for="trattamentoNote">Note</label>
          <textarea id="trattamentoNote" rows="2"></textarea>
          <div class="popup-actions">
            <button class="btn-primary btn-small" type="submit">Salva</button>
            <button class="btn-primary btn-small" type="button" style="background:#ccc;color:#222;margin-left:1rem;" onclick="closeTrattamentoPopup()">Annulla</button>
          </div>
        </form>
      </div>
    </div>

  </div>
  <script>
    // === GLOBAL VARIABLES ===
    let userProfile = null;
    let projects = [];
    let currentProjectIdx = null;
    let plantLists = [];
    let currentPlantIdxForTrattamento = null;
    let suggestionsEngine = null;

    // === VEGETABLE DATABASE ===
    const vegetableDatabase = {
      "pomodoro": {
        varieties: {
          "San Marzano": {
            requirements: {
              sunHours: { min: 6, max: 8 },
              soilTypes: ["Limoso", "Sabbioso"],
              drainage: ["good", "excellent"],
              irrigation: "required"
            },
            careProfile: {
              difficulty: "intermedio",
              timePerWeek: 45
            },
            growthInfo: {
              plantingMonths: [3, 4, 5],
              daysToHarvest: 75,
              yield: "high",
              spaceRequired: 0.5
            }
          },
          "Cherry": {
            requirements: {
              sunHours: { min: 5, max: 8 },
              soilTypes: ["Limoso", "Sabbioso", "Argilloso"],
              drainage: ["fair", "good", "excellent"],
              irrigation: "beneficial"
            },
            careProfile: {
              difficulty: "principiante",
              timePerWeek: 25
            },
            growthInfo: {
              plantingMonths: [3, 4, 5, 6],
              daysToHarvest: 60,
              yield: "very-high",
              spaceRequired: 0.3
            }
          }
        }
      },
      "lattuga": {
        varieties: {
          "Romana": {
            requirements: {
              sunHours: { min: 3, max: 6 },
              soilTypes: ["Limoso", "Sabbioso"],
              drainage: ["good", "excellent"],
              irrigation: "required"
            },
            careProfile: {
              difficulty: "principiante",
              timePerWeek: 15
            },
            growthInfo: {
              plantingMonths: [3, 4, 5, 8, 9],
              daysToHarvest: 35,
              yield: "medium",
              spaceRequired: 0.1
            }
          },
          "Iceberg": {
            requirements: {
              sunHours: { min: 4, max: 6 },
              soilTypes: ["Limoso", "Argilloso"],
              drainage: ["good"],
              irrigation: "required"
            },
            careProfile: {
              difficulty: "principiante",
              timePerWeek: 20
            },
            growthInfo: {
              plantingMonths: [3, 4, 8, 9],
              daysToHarvest: 45,
              yield: "medium",
              spaceRequired: 0.15
            }
          }
        }
      },
      "basilico": {
        varieties: {
          "Genovese": {
            requirements: {
              sunHours: { min: 6, max: 8 },
              soilTypes: ["Limoso", "Sabbioso"],
              drainage: ["good", "excellent"],
              irrigation: "required"
            },
            careProfile: {
              difficulty: "principiante",
              timePerWeek: 20
            },
            growthInfo: {
              plantingMonths: [4, 5, 6],
              daysToHarvest: 30,
              yield: "high",
              spaceRequired: 0.2
            }
          }
        }
      },
      "carota": {
        varieties: {
          "Nantes": {
            requirements: {
              sunHours: { min: 4, max: 7 },
              soilTypes: ["Sabbioso", "Limoso"],
              drainage: ["excellent"],
              irrigation: "beneficial"
            },
            careProfile: {
              difficulty: "intermedio",
              timePerWeek: 25
            },
            growthInfo: {
              plantingMonths: [3, 4, 5, 7, 8],
              daysToHarvest: 70,
              yield: "medium",
              spaceRequired: 0.05
            }
          }
        }
      },
      "zucchina": {
        varieties: {
          "Genovese": {
            requirements: {
              sunHours: { min: 6, max: 8 },
              soilTypes: ["Limoso", "Argilloso"],
              drainage: ["good", "excellent"],
              irrigation: "required"
            },
            careProfile: {
              difficulty: "intermedio",
              timePerWeek: 35
            },
            growthInfo: {
              plantingMonths: [4, 5, 6],
              daysToHarvest: 50,
              yield: "very-high",
              spaceRequired: 1.0
            }
          }
        }
      },
      "peperone": {
        varieties: {
          "Quadrato d'Asti": {
            requirements: {
              sunHours: { min: 6, max: 8 },
              soilTypes: ["Limoso", "Sabbioso"],
              drainage: ["good", "excellent"],
              irrigation: "required"
            },
            careProfile: {
              difficulty: "intermedio",
              timePerWeek: 30
            },
            growthInfo: {
              plantingMonths: [4, 5],
              daysToHarvest: 80,
              yield: "high",
              spaceRequired: 0.4
            }
          }
        }
      }
    };

    // === SUGGESTIONS ENGINE ===
    class VegetableSuggestionsEngine {
      constructor(vegetableDatabase) {
        this.vegetableDatabase = vegetableDatabase;
        console.log('🌱 Suggestions engine initialized with', Object.keys(vegetableDatabase).length, 'vegetables');
      }

      generateSuggestions(environmentalFactors, userProfile, options = {}) {
        console.log('🔍 Generating suggestions...');
        console.log('Environmental factors:', environmentalFactors);
        console.log('User profile:', userProfile);
        
        const { maxSuggestions = 9, minScore = 0.3 } = options; // INCREASED TO 9
        const suggestions = [];
        
        for (const [vegetableName, vegetableData] of Object.entries(this.vegetableDatabase)) {
          for (const [varietyName, varietyData] of Object.entries(vegetableData.varieties)) {
            const score = this.calculateScore(varietyData, environmentalFactors, userProfile);
            console.log(`Score for ${vegetableName} ${varietyName}:`, score);
            
            if (score >= minScore) {
              suggestions.push({
                vegetable: vegetableName,
                variety: varietyName,
                score: { total: score },
                data: varietyData,
                confidence: this.calculateConfidence(score)
              });
            }
          }
        }

        console.log('✅ Generated', suggestions.length, 'suggestions');
        
        return suggestions
          .sort((a, b) => b.score.total - a.score.total)
          .slice(0, maxSuggestions);
      }

      calculateScore(varietyData, environmentalFactors, userProfile) {
        let score = 0.6; // Base score
        
        // Sun exposure match
        const sunHours = environmentalFactors.sunExposure.hoursPerDay;
        if (sunHours >= varietyData.requirements.sunHours.min - 1 && 
            sunHours <= varietyData.requirements.sunHours.max + 1) {
          score += 0.15;
        }
        
        // Soil type match
        if (varietyData.requirements.soilTypes.some(type => 
          environmentalFactors.soilConditions.type.includes(type))) {
          score += 0.15;
        } else {
          score += 0.05; // Partial credit
        }
        
        // Drainage match
        if (varietyData.requirements.drainage.includes(environmentalFactors.soilConditions.drainage)) {
          score += 0.1;
        }
        
        // Experience level match
        const difficultyBonus = this.scoreDifficulty(varietyData.careProfile.difficulty, userProfile.experience);
        score += difficultyBonus * 0.1;
        
        // Space requirement
        if (userProfile.space && userProfile.space.size >= varietyData.growthInfo.spaceRequired) {
          score += 0.1;
        } else if (userProfile.space && userProfile.space.size >= varietyData.growthInfo.spaceRequired * 0.5) {
          score += 0.05; // Partial credit
        }
        
        // Beginner bonus for easy plants
        if (userProfile.experience === 'Principiante' && varietyData.careProfile.difficulty === 'principiante') {
          score += 0.1;
        }
        
        return Math.min(1.0, score);
      }

      scoreDifficulty(plantDifficulty, userExperience) {
        const difficultyMatrix = {
          'Principiante': {
            'principiante': 1.0,
            'intermedio': 0.7,
            'esperto': 0.4
          },
          'Intermedio': {
            'principiante': 0.8,
            'intermedio': 1.0,
            'esperto': 0.9
          },
          'Esperto': {
            'principiante': 0.6,
            'intermedio': 0.9,
            'esperto': 1.0
          }
        };
        return difficultyMatrix[userExperience]?.[plantDifficulty] || 0.5;
      }

      calculateConfidence(score) {
        if (score >= 0.8) return 'very-high';
        if (score >= 0.7) return 'high';
        if (score >= 0.6) return 'medium';
        return 'low';
      }
    }

    // === INITIALIZATION FUNCTION ===
    function initializeApp() {
      console.log('🚀 Initializing app...');
      
      // Always initialize the suggestions engine
      if (!suggestionsEngine) {
        suggestionsEngine = new VegetableSuggestionsEngine(vegetableDatabase);
        console.log('✅ Suggestions engine created');
      }
      
      // Create default user profile if missing
      if (!userProfile) {
        userProfile = {
          experience: 'Principiante',
          timeCommitment: {
            minutesPerDay: 30,
            frequency: 'daily'
          },
          primaryGoal: 'Coltivare il mio cibo',
          seasonalTips: 'Sì',
          space: { size: 20, type: 'garden' }
        };
        console.log('✅ Default user profile created:', userProfile);
      }
    }

    // === MAIN FUNCTIONS ===
    function showScreen(screenId) {
      document.getElementById('onboardingForm').classList.add('hidden');
      document.getElementById('homepage').classList.add('hidden');
      document.getElementById('projectForm1').classList.add('hidden');
      document.getElementById('projectForm2').classList.add('hidden');
      document.getElementById('projectDashboard').classList.add('hidden');
      document.getElementById('addPlantWireframe').style.display = 'none';
      document.getElementById('editSpecsForm').classList.add('hidden');
      if (document.getElementById(screenId)) {
        document.getElementById(screenId).classList.remove('hidden');
      }
    }

    document.getElementById('onboardingForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const timeAmount = parseInt(document.getElementById('timeAmount').value);
      const timeUnit = document.getElementById('timeUnit').value;
      
      let minutesPerDay = 0;
      if (timeUnit.includes('minuti al giorno')) {
        minutesPerDay = timeAmount;
      } else if (timeUnit.includes('ore al giorno')) {
        minutesPerDay = timeAmount * 60;
      } else if (timeUnit.includes('minuti a settimana')) {
        minutesPerDay = timeAmount / 7;
      } else if (timeUnit.includes('ore a settimana')) {
        minutesPerDay = (timeAmount * 60) / 7;
      }

      userProfile = {
        experience: document.getElementById('experience').value,
        timeCommitment: {
          minutesPerDay: minutesPerDay,
          frequency: 'daily'
        },
        primaryGoal: document.getElementById('goal').value,
        seasonalTips: document.getElementById('tips').value,
        space: { size: 20, type: 'garden' } // Default space
      };

      console.log('✅ User profile created from onboarding:', userProfile);

      // Initialize suggestions engine
      if (!suggestionsEngine) {
        suggestionsEngine = new VegetableSuggestionsEngine(vegetableDatabase);
        console.log('✅ Suggestions engine initialized from onboarding');
      }
      
      showScreen('homepage');
      renderProjectArea();
    });

    function showHomepage() {
      initializeApp(); // Ensure initialization
      showScreen('homepage');
      renderProjectArea();
    }

    function goHome(event) {
      event.preventDefault();
      initializeApp(); // Ensure initialization
      showHomepage();
    }

    function renderProjectArea() {
      const area = document.getElementById('projectArea');
      area.innerHTML = '';
      if (projects.length === 0) {
        const btn = document.createElement('button');
        btn.textContent = 'Crea il tuo primo progetto';
        btn.className = 'btn-primary';
        btn.onclick = showProjectForm;
        area.appendChild(btn);
      } else {
        projects.forEach((proj, idx) => {
          const card = document.createElement('div');
          card.className = 'project-card';
          card.innerHTML = `
            <h3>${proj.location}</h3>
            <div class="project-info"><strong>Tipo di terreno:</strong> ${proj.type}</div>
            <div class="project-info"><strong>Dimensione:</strong> ${proj.size}</div>
            <div class="project-info"><strong>Suolo:</strong> ${proj.soilConditions.join(', ') || 'N/D'}</div>
            <div class="project-info"><strong>Sole:</strong> ${proj.sunExposure.join(', ') || 'N/D'}</div>
            <div class="project-info"><strong>Ambiente:</strong> ${proj.environment.join(', ') || 'N/D'}</div>
            <button class="btn-primary" onclick="openProjectDashboard(${idx})">Apri Progetto</button>
          `;
          area.appendChild(card);
        });
      }
    }

    function showProjectForm() {
      initializeApp(); // Ensure initialization
      document.getElementById('projLocation').value = '';
      document.getElementById('projType').value = '';
      document.getElementById('projSize').value = '';
      document.querySelectorAll('#projectForm2 input[type=checkbox]').forEach(cb => cb.checked = false);
      showScreen('projectForm1');
    }

    document.getElementById('nextToSoil').onclick = function() {
      const location = document.getElementById('projLocation').value.trim();
      const type = document.getElementById('projType').value;
      const size = document.getElementById('projSize').value.trim();
      if (!location) {
        alert('Inserisci indirizzo o posizione GPS.');
        return;
      }
      if (!type) {
        alert('Seleziona il tipo di terreno.');
        return;
      }
      if (!size) {
        alert('Inserisci la dimensione del terreno.');
        return;
      }
      showScreen('projectForm2');
    };

    document.getElementById('backToDetails').onclick = function() {
      showScreen('projectForm1');
    };

    document.getElementById('projectForm2').addEventListener('submit', function(e) {
      e.preventDefault();
      const location = document.getElementById('projLocation').value.trim();
      const type = document.getElementById('projType').value;
      const size = document.getElementById('projSize').value.trim();
      const soilConditions = Array.from(document.querySelectorAll('input[name="soil"]:checked')).map(cb => cb.value);
      const sunExposure = Array.from(document.querySelectorAll('input[name="sun"]:checked')).map(cb => cb.value);
      const environment = Array.from(document.querySelectorAll('input[name="environment"]:checked')).map(cb => cb.value);

      projects.push({
        location,
        type,
        size,
        soilConditions,
        sunExposure,
        environment
      });
      
      // Update user profile with actual space information
      if (userProfile) {
        userProfile.space = {
          size: parseInt(size) || 20,
          type: type.toLowerCase()
        };
        console.log('✅ Updated user profile space:', userProfile.space);
      }
      
      plantLists.push([]);
      showHomepage();
    });

    function openProjectDashboard(idx) {
      initializeApp(); // Ensure initialization
      currentProjectIdx = idx;
      console.log('📊 Opened project dashboard for project:', idx);
      showScreen('projectDashboard');
      showDashboardTab('overview');
    }

    function generateEnvironmentalFactors(project) {
      // Ensure we have default values
      const sunHours = project.sunExposure && project.sunExposure.length > 0 ? 
                       (project.sunExposure.includes('Pieno Sole') ? 7 : 
                        project.sunExposure.includes('Mezzo Sole') ? 5 : 3) : 6;
      
      const drainage = project.environment && project.environment.length > 0 ?
                       (project.environment.includes('Buon Drenaggio') ? 'good' : 
                        project.environment.includes('Scarso Drenaggio') ? 'poor' : 'fair') : 'good';
      
      const soilTypes = project.soilConditions && project.soilConditions.length > 0 ? 
                        project.soilConditions : ['Limoso'];
      
      const factors = {
        location: {
          coordinates: { lat: 41.9, lng: 12.5 },
          address: project.location,
          averageRainfall: 600,
          altitude: 100,
          frostRisk: 'low'
        },
        sunExposure: {
          hoursPerDay: sunHours,
          intensity: 'medium',
          pattern: project.sunExposure && project.sunExposure[0] ? project.sunExposure[0] : 'full-sun'
        },
        soilConditions: {
          type: soilTypes,
          drainage: drainage,
          ph: 6.5,
          fertility: 'medium'
        },
        irrigationAvailable: project.environment ? project.environment.includes('Irrigazione disponibile') : false
      };
      
      console.log('🌍 Generated environmental factors:', factors);
      return factors;
    }

    function renderSmartSuggestions(containerId = 'smartSuggestionsGrid') {
      console.log('🎯 renderSmartSuggestions called for container:', containerId);
      console.log('🔧 suggestionsEngine exists:', !!suggestionsEngine);
      console.log('👤 userProfile exists:', !!userProfile);
      console.log('📁 currentProjectIdx:', currentProjectIdx);

      // Force initialization if missing
      if (!suggestionsEngine || !userProfile) {
        console.log('⚠️ Missing requirements, initializing...');
        initializeApp();
      }

      if (!suggestionsEngine || !userProfile) {
        console.log('❌ Still missing requirements after initialization');
        const grid = document.getElementById(containerId);
        if (grid) {
          grid.innerHTML = '<p style="color: red;">Errore: Completa prima l\'onboarding dall\'inizio.</p>';
        }
        return;
      }

      if (currentProjectIdx === null || !projects[currentProjectIdx]) {
        console.log('❌ No project selected');
        const grid = document.getElementById(containerId);
        if (grid) {
          grid.innerHTML = '<p style="color: orange;">Seleziona un progetto per vedere i suggerimenti.</p>';
        }
        return;
      }

      const project = projects[currentProjectIdx];
      console.log('📋 Current project:', project);
      
      const environmentalFactors = generateEnvironmentalFactors(project);
      
      const suggestions = suggestionsEngine.generateSuggestions(
        environmentalFactors, 
        userProfile,
        { maxSuggestions: 9, minScore: 0.3 } // INCREASED TO 9
      );

      console.log('📝 Final suggestions:', suggestions);

      const grid = document.getElementById(containerId);
      if (!grid) {
        console.log('❌ Grid container not found:', containerId);
        return;
      }

      grid.innerHTML = '';

      if (suggestions.length === 0) {
        grid.innerHTML = '<p style="color: orange;">Nessun suggerimento generato. Prova a modificare le condizioni del progetto.</p>';
        return;
      }

      suggestions.forEach(suggestion => {
        const plantCard = document.createElement('div');
        plantCard.className = 'plant-card';
        
        // Different click behavior for overview vs add plant
        if (containerId === 'smartSuggestionsGridOverview') {
          plantCard.onclick = () => {
            // Navigate to add plant screen with pre-filled data
            showAddPlantWireframe();
            fillPlantForm(suggestion.vegetable, suggestion.variety);
          };
        } else {
          plantCard.onclick = () => fillPlantForm(suggestion.vegetable, suggestion.variety);
        }
        
        const confidenceBadge = `<div class="confidence-badge confidence-${suggestion.confidence}">${suggestion.confidence.replace('-', ' ').toUpperCase()}</div>`;
        const scoreDisplay = `<div class="score-display">${Math.round(suggestion.score.total * 100)}% compatibilità</div>`;
        
        let imageUrl = '';
        switch(suggestion.vegetable.toLowerCase()) {
          case 'pomodoro':
            imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Tomato_je.jpg';
            break;
          case 'lattuga':
            imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/3/3a/Lettuce_01.jpg';
            break;
          case 'basilico':
            imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/4/44/Basil-Basilico-Ocimum_basilicum-dbaron.jpg';
            break;
          case 'carota':
            imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/5/58/Carrots_of_many_colors.jpg';
            break;
          case 'zucchina':
            imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/3/3a/Zucchini_and_flower.jpg';
            break;
          case 'peperone':
            imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/7/7b/Red_and_green_bell_peppers.jpg';
            break;
          default:
            imageUrl = 'https://upload.wikimedia.org/wikipedia/commons/8/89/Tomato_je.jpg';
        }

        plantCard.innerHTML = `
          ${confidenceBadge}
          <img src="${imageUrl}" alt="${suggestion.vegetable}" onerror="this.style.display='none';" />
          <div class="plant-card-name">${suggestion.vegetable}</div>
          <div style="font-size:0.9em;color:#388e3c;">${suggestion.variety}</div>
          ${scoreDisplay}
        `;

        grid.appendChild(plantCard);
      });

      console.log('✅ Suggestions rendered to grid successfully');
    }

    // TASK GENERATION FUNCTIONS (keeping existing)
    function generateTasksForPlants(plants) {
      const tasks = [];
      const today = new Date();

      plants.forEach(plant => {
        if (!plant.type) return;
        
        const plantName = plant.type.toLowerCase();
        
        tasks.push({
          plantName: plant.type,
          title: 'Innaffiare',
          description: getWateringDescription(plantName),
          dueDate: new Date(today.getTime() + 1 * 24 * 60 * 60 * 1000),
          priority: getWateringPriority(plantName),
          status: 'upcoming',
          taskType: 'Innaffiare'
        });

        if (!plantName.includes('lattuga') && !plantName.includes('rucola')) {
          tasks.push({
            plantName: plant.type,
            title: 'Concimazione',
            description: getFertilizingDescription(plantName),
            dueDate: new Date(today.getTime()),
            priority: 'medium',
            status: 'due-today',
            taskType: 'Concimazione'
          });
        }

        if (plantName.includes('pomodoro') || plantName.includes('basilico') || plantName.includes('peperone')) {
          tasks.push({
            plantName: plant.type,
            title: 'Potatura',
            description: getPruningDescription(plantName),
            dueDate: new Date(today.getTime() - 1 * 24 * 60 * 60 * 1000),
            priority: 'medium',
            status: 'overdue',
            taskType: 'Potatura'
          });
        }

        if (!plantName.includes('carota') || new Date(plant.date).getTime() < today.getTime() - 60 * 24 * 60 * 60 * 1000) {
          tasks.push({
            plantName: plant.type,
            title: 'Raccolta',
            description: getHarvestDescription(plantName),
            dueDate: new Date(today.getTime() + getHarvestDays(plantName) * 24 * 60 * 60 * 1000),
            priority: 'low',
            status: 'upcoming',
            taskType: 'Raccolta'
          });
        }

        tasks.push({
          plantName: plant.type,
          title: 'Controllo Parassiti',
          description: 'Controllare foglie e stelo per segni di parassiti o malattie',
          dueDate: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000),
          priority: 'low',
          status: 'upcoming',
          taskType: 'Controllo Parassiti'
        });
      });

      return tasks;
    }

    function getWateringDescription(plantName) {
      if (plantName.includes('pomodoro')) return 'Innaffiare regolarmente, evitando le foglie';
      if (plantName.includes('lattuga')) return 'Mantenere il terreno umido ma non bagnato';
      if (plantName.includes('basilico')) return 'Innaffiare alla base, evitare le foglie';
      if (plantName.includes('carota')) return 'Innaffiare delicatamente per non disturbare le radici';
      return 'Innaffiare secondo le necessità della pianta';
    }

    function getWateringPriority(plantName) {
      if (plantName.includes('pomodoro') || plantName.includes('basilico')) return 'high';
      if (plantName.includes('lattuga')) return 'medium';
      return 'medium';
    }

    function getFertilizingDescription(plantName) {
      if (plantName.includes('pomodoro')) return 'Aggiungere fertilizzante ricco di potassio';
      if (plantName.includes('zucchina')) return 'Concime organico ricco di azoto';
      if (plantName.includes('peperone')) return 'Fertilizzante bilanciato NPK';
      return 'Concime organico generale';
    }

    function getPruningDescription(plantName) {
      if (plantName.includes('pomodoro')) return 'Rimuovere i germogli laterali (femminelle)';
      if (plantName.includes('basilico')) return 'Pizzicare i fiori per mantenere il sapore delle foglie';
      if (plantName.includes('peperone')) return 'Rimuovere foglie gialle e germogli deboli';
      return 'Potatura generale della pianta';
    }

    function getHarvestDescription(plantName) {
      if (plantName.includes('pomodoro')) return 'Raccogliere i pomodori quando sono maturi';
      if (plantName.includes('lattuga')) return 'Raccogliere le foglie esterne';
      if (plantName.includes('basilico')) return 'Raccogliere le foglie fresche al mattino';
      if (plantName.includes('zucchina')) return 'Raccogliere quando le zucchine sono ancora tenere';
      return 'Raccogliere quando il prodotto è maturo';
    }

    function getHarvestDays(plantName) {
      if (plantName.includes('lattuga') || plantName.includes('basilico')) return 2;
      if (plantName.includes('zucchina')) return 5;
      if (plantName.includes('pomodoro')) return 7;
      return 7;
    }

    function showDashboardTab(tab) {
      const proj = projects[currentProjectIdx];
      const plants = plantLists[currentProjectIdx] || [];
      let html = '';
      
      if (tab === 'overview') {
        html = `
          <h2>Dashboard Progetto: ${proj.location}</h2>
          <div class="dashboard-summary">
            <div class="card">
              <button class="edit-icon" title="Modifica" onclick="showSpecsEdit(event)"><span aria-hidden="true">✏️</span></button>
              <strong>Tipo di terreno:</strong> ${proj.type}<br>
              <strong>Dimensione:</strong> ${proj.size}<br>
              <strong>Suolo:</strong> ${proj.soilConditions.join(', ') || 'N/D'}<br>
              <strong>Sole:</strong> ${proj.sunExposure.join(', ') || 'N/D'}<br>
              <strong>Ambiente:</strong> ${proj.environment.join(', ') || 'N/D'}
            </div>
            <div class="card">
              <strong>Piante:</strong> ${plants.length} tipi<br>
              <strong>Totale piante:</strong> ${plants.reduce((sum, p) => sum + p.quantity, 0)}<br>
              <strong>Prossima attività:</strong> Innaffia i pomodori domani
            </div>
          </div>
          <div class="card">
            <strong>Lista Piante</strong>
            <ul class="plant-list" id="plantListDashboard">
              ${plants.length === 0 ? '<li>Nessuna pianta ancora.</li>' : plants.map(p =>
                `<li><span>${p.type} (${p.quantity})</span><span>Piantato: ${p.date}</span></li>`
              ).join('')}
            </ul>
            <button class="btn-primary" onclick="showAddPlantWireframe()">${plants.length === 0 ? 'Crea la tua prima pianta' : 'Aggiungi pianta'}</button>
          </div>
          <div id="smartSuggestionsOverview" style="margin-top: 2rem; text-align: left;">
            <h3 style="color: #388e3c;">🎯 Suggerimenti per le tue condizioni</h3>
            <div class="suggested-plants-grid" id="smartSuggestionsGridOverview">
              <!-- Suggestions will be dynamically inserted here -->
            </div>
          </div>
        `;
        document.getElementById('dashboardContent').innerHTML = html;
        
        // Render suggestions in the overview
        setTimeout(() => {
          renderSmartSuggestions('smartSuggestionsGridOverview');
        }, 100);
        
      } else if (tab === 'plants') {
        // Plant management (existing code)
        html += `
          <h2>Le tue piante</h2>
          <div class="responsive-table-container">
          ${plants.length === 0 ? '<p>Nessuna pianta ancora.</p>' : `
            <table class="plant-table">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Varietà</th>
                  <th>Quantità</th>
                  <th>Data di semina</th>
                  <th>Note</th>
                  <th>Trattamenti speciali</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                ${plants.map((p, idx) => {
                  let [nome, ...varietaArr] = p.type.split(' (');
                  let varieta = varietaArr.length ? varietaArr.join(' (').replace(/\)$/, '') : '';
                  let trattamenti = (p.trattamenti && p.trattamenti.length)
                    ? `<ul style="padding-left:1em;margin:0;">${p.trattamenti.map(t =>
                        `<li><strong>${t.nome}</strong> <span style="color:#388e3c;">${t.data}</span> <span style="color:#666;">${t.cadence}</span>${t.note?': '+t.note:''}</li>`
                      ).join('')}</ul>`
                    : '<span style="color:#888;">Nessuno</span>';
                  return `<tr>
                    <td>${nome}</td>
                    <td>${varieta}</td>
                    <td>${p.quantity}</td>
                    <td>${p.date}</td>
                    <td>${p.notes || ''}</td>
                    <td>${trattamenti}</td>
                    <td><button class="btn-primary btn-small" onclick="openTrattamentoPopup(${idx})">Trattamenti speciali</button></td>
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          `}
          </div>
          <button class="btn-primary" style="margin-top:1.5rem;" onclick="showAddPlantWireframe()">Aggiungi pianta</button>
        `;
        document.getElementById('dashboardContent').innerHTML = html;
      } else if (tab === 'tasks') {
        // Task management with categories
        const allTasks = generateTasksForPlants(plants);
        
        if (allTasks.length === 0) {
          html = `
            <h2>Attività</h2>
            <div class="no-tasks">Nessuna attività programmata. Aggiungi delle piante per vedere le attività!</div>
          `;
        } else {
          const taskCategories = {};
          allTasks.forEach(task => {
            if (!taskCategories[task.taskType]) {
              taskCategories[task.taskType] = [];
            }
            taskCategories[task.taskType].push(task);
          });

          const taskIcons = {
            'Innaffiare': '💧',
            'Concimazione': '🌱',
            'Potatura': '✂️',
            'Raccolta': '🍅',
            'Controllo Parassiti': '🔍'
          };

          html = `<h2>Attività per Tipo</h2>`;
          
          Object.keys(taskCategories).forEach(taskType => {
            const categoryTasks = taskCategories[taskType];
            const taskIcon = taskIcons[taskType] || '📋';
            
            html += `
              <div class="task-category">
                <div class="task-category-header">
                  <span class="icon">${taskIcon}</span>
                  ${taskType}
                </div>
                ${categoryTasks.map((task, idx) => `
                  <div class="task-item ${task.status}" data-filter="${task.status}">
                    <div class="task-header">
                      <div>
                        <div class="task-title">${task.title}</div>
                        <div class="task-plant">🌱 ${task.plantName}</div>
                      </div>
                      <div class="task-priority ${task.priority}">${task.priority.toUpperCase()}</div>
                    </div>
                    <div class="task-description">${task.description}</div>
                    <div class="task-due-date ${task.status}">
                      📅 Scadenza: ${task.dueDate.toLocaleDateString('it-IT')}
                    </div>
                    <div class="task-actions">
                      <button class="task-btn complete" onclick="markTaskComplete(${idx})">Completa</button>
                      <button class="task-btn postpone" onclick="postponeTask(${idx})">Posticipa</button>
                      <button class="task-btn skip" onclick="skipTask(${idx})">Salta</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `;
          });
        }
        
        document.getElementById('dashboardContent').innerHTML = html;
      } else {
        document.getElementById('dashboardContent').innerHTML = `<h2>${tab.charAt(0).toUpperCase() + tab.slice(1)} (Presto disponibile)</h2>`;
      }
    }

    function showAddPlantWireframe() {
      console.log('🌱 showAddPlantWireframe called');
      document.getElementById('addPlantWireframe').style.display = 'block';
      document.getElementById('projectDashboard').classList.add('hidden');
      document.getElementById('plantTypeWire').value = '';
      document.getElementById('plantVarietyWire').value = '';
      document.getElementById('plantQuantityWire').value = '';
      document.getElementById('plantDateWire').value = '';
      document.getElementById('plantNotesWire').value = '';
      
      // Generate suggestions for add plant screen
      setTimeout(() => {
        renderSmartSuggestions('smartSuggestionsGrid');
      }, 100);
    }

    function cancelAddPlantWire() {
      document.getElementById('addPlantWireframe').style.display = 'none';
      document.getElementById('projectDashboard').classList.remove('hidden');
      showDashboardTab('plants');
    }

    function fillPlantForm(nome, varieta) {
      console.log('🔧 Filling plant form with:', nome, varieta);
      document.getElementById('plantTypeWire').value = nome;
      document.getElementById('plantVarietyWire').value = varieta;
    }

    function saveWirePlant() {
      const type = document.getElementById('plantTypeWire').value.trim();
      const variety = document.getElementById('plantVarietyWire').value.trim();
      const quantity = parseInt(document.getElementById('plantQuantityWire').value);
      const date = document.getElementById('plantDateWire').value;
      const notes = document.getElementById('plantNotesWire').value.trim();
      if (!type || !quantity || !date) {
        alert('Compila tutti i campi obbligatori.');
        return;
      }
      plantLists[currentProjectIdx].push({
        type: type + (variety ? ' (' + variety + ')' : ''),
        quantity,
        date,
        notes
      });
      document.getElementById('addPlantWireframe').style.display = 'none';
      document.getElementById('projectDashboard').classList.remove('hidden');
      showDashboardTab('plants');
    }

    function showSpecsEdit(event) {
      if(event) { event.preventDefault(); event.stopPropagation(); }
      const proj = projects[currentProjectIdx];
      if (!proj) {
        alert("Nessun progetto selezionato.");
        return;
      }
      showScreen('editSpecsForm');
      document.getElementById('editProjType').value = proj.type || "";
      document.getElementById('editProjSize').value = proj.size || "";

      Array.from(document.querySelectorAll('input[name="editSoil"]')).forEach(cb => {
        cb.checked = (proj.soilConditions || []).includes(cb.value);
      });
      Array.from(document.querySelectorAll('input[name="editSun"]')).forEach(cb => {
        cb.checked = (proj.sunExposure || []).includes(cb.value);
      });
      Array.from(document.querySelectorAll('input[name="editEnv"]')).forEach(cb => {
        cb.checked = (proj.environment || []).includes(cb.value);
      });
    }

    function saveSpecsEdit() {
      const proj = projects[currentProjectIdx];
      proj.type = document.getElementById('editProjType').value;
      proj.size = document.getElementById('editProjSize').value;
      proj.soilConditions = Array.from(document.querySelectorAll('input[name="editSoil"]:checked')).map(cb => cb.value);
      proj.sunExposure = Array.from(document.querySelectorAll('input[name="editSun"]:checked')).map(cb => cb.value);
      proj.environment = Array.from(document.querySelectorAll('input[name="editEnv"]:checked')).map(cb => cb.value);
      showScreen('projectDashboard');
      showDashboardTab('overview');
    }

    function cancelSpecsEdit() {
      showScreen('projectDashboard');
      showDashboardTab('overview');
    }

    function openTrattamentoPopup(plantIdx) {
      currentPlantIdxForTrattamento = plantIdx;
      document.getElementById('trattamentoNome').value = '';
      document.getElementById('trattamentoCadence').value = '';
      document.getElementById('trattamentoData').value = '';
      document.getElementById('trattamentoNote').value = '';
      document.getElementById('trattamentoPopup').style.display = 'flex';
    }

    function closeTrattamentoPopup() {
      document.getElementById('trattamentoPopup').style.display = 'none';
      currentPlantIdxForTrattamento = null;
    }

    function saveTrattamento() {
      const nome = document.getElementById('trattamentoNome').value.trim();
      const cadence = document.getElementById('trattamentoCadence').value.trim();
      const data = document.getElementById('trattamentoData').value;
      const note = document.getElementById('trattamentoNote').value.trim();
      if (!nome || !cadence || !data) {
        alert('Compila nome, cadenza e data trattamento.');
        return;
      }
      const plant = plantLists[currentProjectIdx][currentPlantIdxForTrattamento];
      if (!plant.trattamenti) plant.trattamenti = [];
      plant.trattamenti.push({ nome, cadence, data, note });
      closeTrattamentoPopup();
      showDashboardTab('plants');
    }

    function markTaskComplete(taskIdx) {
      alert('Attività completata!');
    }

    function postponeTask(taskIdx) {
      alert('Attività posticipata di 3 giorni');
    }

    function skipTask(taskIdx) {
      alert('Attività saltata');
    }

    showScreen('onboardingForm');
  </script>
</body>
</html>
